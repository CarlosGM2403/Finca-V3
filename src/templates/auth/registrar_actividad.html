{% extends 'base.html' %}

{% block title %}Registrar Actividad{% endblock %}

{% block CustomCSS %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/registrar_actividad.css') }}">
{% endblock %}

{% block body %}
<div class="logo">
    <img src="{{ url_for('static', filename='img/logo_icon.png') }}" alt="Logo">
</div>

<h1>¡Registrar Mi Actividad!</h1>

<div class="actividad-container">

  <form method="POST" enctype="multipart/form-data">

    <!-- Fila de selects + imagen -->
    <div class="form-row">
      <div class="form-inputs">
        <!-- Tipo de actividad -->
        <label for="actividad" align="left">Tipo de actividad</label>
        <select name="actividad" id="actividad" required>
          <option value="cafe">Cosecha de Café</option>
          <option value="limon">Cosecha de Limón</option>
          <option value="mani">Cosecha de Maní</option>
          <option value="fumigacion">Fumigación</option>
        </select>

        <!-- Insumos -->
        <label for="insumos" align="left">Insumos utilizados</label>
        <select name="insumos" id="insumos" required>
          <option value="ninguno">Ninguno</option>
          <option value="fertilizante">Fertilizante</option>
          <option value="herbicida">Herbicida</option>
          <option value="semillas">Semillas</option>
        </select>
      </div>

      <!-- Imagen a la derecha -->
      <div class="form-image">
        <img src="{{ url_for('static', filename='img/agricultor.png') }}" alt="Actividad">
      </div>
    </div>

    <!-- Observaciones -->
    <label for="observaciones" align="left">Observaciones</label>
    <textarea name="observaciones" id="observaciones" rows="4" required></textarea>

    <!-- Tomar evidencia + botones -->
    <label for="evidencia" align="left">Tomar evidencia</label>
    <div class="acciones-evidencia">
      <div class="acciones-izquierda">
        <button type="button" id="cameraBtn" class="camera-btn">
          <i class="fas fa-camera"></i> Tomar foto
        </button>
        <a href="{{ url_for('ver_fotos') }}" class="btn-fotos">Ver Fotos</a>
      </div>

      <div class="acciones-derecha">
        <button type="submit" class="btn-guardar">Guardar</button>
        <a href="{{ url_for('home') }}" class="btn-salir">Salir</a>
      </div>
    </div>

    <!-- Vista previa de la foto -->
    <div id="preview" class="preview"></div>

    <!-- Input oculto para guardar la foto en base64 -->
    <input type="hidden" id="evidencia" name="evidencia">

  </form>
</div>

<div class="planta">
  <img src="{{ url_for('static', filename='img/plantaa.png') }}" alt="planta">
</div>

<!-- Script para manejar cámara -->
<script>
const cameraBtn = document.getElementById('cameraBtn');
const evidenciaInput = document.getElementById('evidencia');
const preview = document.getElementById('preview');

cameraBtn.addEventListener('click', async () => {
  try {
    // Verificar si hay dispositivos de video
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cameras = devices.filter(d => d.kind === "videoinput");

    if (cameras.length === 0) {
      alert("Este dispositivo no tiene cámara disponible.");
      return;
    }

    // Usar la cámara por defecto
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);

    // Tomar la foto directamente
    const photo = await imageCapture.takePhoto();
    const reader = new FileReader();

    reader.onloadend = () => {
      evidenciaInput.value = reader.result; // Guardamos en base64
      preview.innerHTML = `<img src="${reader.result}" alt="Foto tomada">`;
    };

    reader.readAsDataURL(photo);

    // Liberar cámara después de tomar la foto
    track.stop();

  } catch (err) {
    alert("Error al acceder a la cámara: " + err.message);
  }
});
</script>
{% endblock %}
