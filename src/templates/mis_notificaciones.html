{% extends 'base.html' %}

{% block title %}Mis Notificaciones{% endblock %}

{% block CustomCSS %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/mis_notificaciones.css') }}">
{% endblock %}

{% block body %}

<div class="logo">
    <img src="{{ url_for('static', filename='img/logo_icon.png') }}" alt="Logo">
</div>

<div class="logout-btn">
    <a href="{{ url_for('home') }}">
        <button title="Volver al inicio">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
    </a>
</div>

<div class="container">
    <div class="header-notificaciones">
        <h1>
            <i class="fa-solid fa-bell"></i>
            Mis Notificaciones
            {% if no_leidas > 0 %}
            <span class="badge-contador">{{ no_leidas }} nueva{{ 's' if no_leidas > 1 else '' }}</span>
            {% endif %}
        </h1>
        
        <div class="filtros-notificaciones">
            <button class="btn-filtro active" data-filtro="todas">
                <i class="fa-solid fa-list"></i> Todas
            </button>
            <button class="btn-filtro" data-filtro="no-leidas">
                <i class="fa-solid fa-envelope"></i> No leídas
            </button>
        </div>
    </div>

    <div class="notificaciones-grid">
        {% if notificaciones %}
            {% for notif in notificaciones %}
            
            {# ===== NOTIFICACIONES GENERALES (Para administradores) ===== #}
            {% if notif.tipo_notif == 'general' %}
            <div class="notificacion-card general {% if notif.leida == 1 %}leida{% endif %}" 
                 data-tipo="general" 
                 data-leida="{{ notif.leida }}">
                <div class="notificacion-header">
                    <span class="tipo-badge general">
                        {% if notif.tipo == 'nueva_actividad' %}
                        <i class="fa-solid fa-tasks"></i> Nueva Actividad
                        {% elif notif.tipo == 'nueva_produccion' %}
                        <i class="fa-solid fa-seedling"></i> Nueva Producción
                        {% elif notif.tipo == 'nueva_venta' %}
                        <i class="fa-solid fa-dollar-sign"></i> Nueva Venta
                        {% elif notif.tipo == 'solicitud_insumo' %}
                        <i class="fa-solid fa-box"></i> Solicitud de Insumo
                        {% elif notif.tipo == 'nuevo_tratamiento' %}
                        <i class="fa-solid fa-leaf"></i> Nuevo Tratamiento
                        {% elif notif.tipo == 'nuevo_problema' %}
                        <i class="fa-solid fa-exclamation-triangle"></i> Problema Reportado
                        {% else %}
                        <i class="fa-solid fa-bell"></i> Notificación
                        {% endif %}
                    </span>
                    <span class="fecha">
                        <i class="fa-regular fa-clock"></i>
                        {{ notif.fecha.strftime('%d/%m/%Y %H:%M') }}
                    </span>
                </div>

                <div class="notificacion-body">
                    <div class="mensaje">
                        {{ notif.mensaje }}
                    </div>
                    
                    {% if notif.referencia_id %}
                    <div class="info-adicional">
                        <i class="fa-solid fa-hashtag"></i> Referencia: #{{ notif.referencia_id }}
                    </div>
                    {% endif %}
                </div>

                <div class="notificacion-footer">
                    {% if notif.leida == 0 %}
                    <form method="POST" action="{{ url_for('marcar_notificacion_leida', id=notif.id) }}" style="width: 100%; max-width: 300px;">
                        <input type="hidden" name="tipo_notif" value="general">
                        <button type="submit" class="btn-confirmar">
                            <i class="fa-solid fa-check"></i> Marcar como leída
                        </button>
                    </form>
                    {% else %}
                    <span class="estado-leida">
                        <i class="fa-solid fa-check-double"></i> Leída
                    </span>
                    {% endif %}
                </div>
            </div>
            
            {# ===== NOTIFICACIONES PERSONALES (Insumos) ===== #}
            {% elif notif.tipo_notif == 'personal' %}
            <div class="notificacion-card {{ notif.tipo }} {% if notif.leida == 1 %}leida{% endif %}" 
                 data-tipo="{{ notif.tipo }}" 
                 data-leida="{{ notif.leida }}">
                <div class="notificacion-header">
                    <span class="tipo-badge {{ notif.tipo }}">
                        {% if notif.tipo == 'aceptada' %}
                        <i class="fa-solid fa-check-circle"></i> Aceptada
                        {% elif notif.tipo == 'rechazada' %}
                        <i class="fa-solid fa-times-circle"></i> Rechazada
                        {% else %}
                        <i class="fa-solid fa-clock"></i> Pendiente
                        {% endif %}
                    </span>
                    <span class="fecha">
                        <i class="fa-regular fa-clock"></i>
                        {{ notif.fecha.strftime('%d/%m/%Y %H:%M') }}
                    </span>
                </div>

                <div class="notificacion-body">
                    <div class="mensaje">
                        {{ notif.mensaje }}
                    </div>
                    
                    {% if notif.solicitud_id %}
                    <div class="info-adicional">
                        <i class="fa-solid fa-hashtag"></i> Solicitud: #{{ notif.solicitud_id }}
                    </div>
                    {% endif %}
                </div>

                <div class="notificacion-footer">
                    {% if notif.leida == 0 %}
                    <form method="POST" action="{{ url_for('marcar_notificacion_leida', id=notif.id) }}" style="width: 100%; max-width: 300px;">
                        <input type="hidden" name="tipo_notif" value="personal">
                        <button type="submit" class="btn-confirmar">
                            <i class="fa-solid fa-check"></i> Marcar como leída
                        </button>
                    </form>
                    {% else %}
                    <span class="estado-leida">
                        <i class="fa-solid fa-check-double"></i> Leída
                    </span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% endfor %}
        {% else %}
        <div class="sin-notificaciones">
            <i class="fa-regular fa-bell-slash"></i>
            <h3>No tienes notificaciones</h3>
            <p>Aquí aparecerán las notificaciones del sistema</p>
        </div>
        {% endif %}
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div id="flash-data" data-icon="{{ category }}" data-message="{{ message }}"></div>
    {% endfor %}
  {% endif %}
{% endwith %}

{%endblock%}